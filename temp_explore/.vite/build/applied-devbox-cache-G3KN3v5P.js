"use strict";Object.defineProperty(exports,Symbol.toStringTag,{value:"Module"});const n=require("node:fs/promises"),E=require("node:path"),d=require("./main-B6C8fi5S.js");require("path");require("node:fs");require("node:crypto");require("node:child_process");require("node:buffer");require("node:os");require("node:string_decoder");require("node:net");require("crypto");require("child_process");const o=d.getTaggedLoggerLazy("applied-devbox-cache"),m=3e4,I=2e4,O="host-cache",S="applied-devbox-ls.json";function A(e){return E.join(e,O,S)}function h(){const e=process.env.CODEX_APP_APPLIED_DEVBOX_REFRESH_INTERVAL_MS;if(!e)return m;const t=Number(e);return!Number.isFinite(t)||t<=0?(o().warning("Invalid CODEX_APP_APPLIED_DEVBOX_REFRESH_INTERVAL_MS",{value:e}),m):t}function w(e){const t=e.trim();if(!t)return[];try{const i=JSON.parse(t);if(!Array.isArray(i))return o().warning("Applied devbox ls returned non-array JSON",{payloadPreview:t.slice(0,200)}),null;const a=i.filter(r=>typeof r=="string").map(r=>r.trim()).filter(r=>r.length>0);return[...new Set(a)]}catch{return o().warning("Applied devbox ls returned invalid JSON",{payloadPreview:t.slice(0,200)}),null}}async function b(e,t){await n.mkdir(E.dirname(e),{recursive:!0,mode:448});const i=`${e}.tmp-${process.pid}-${Date.now()}`;await n.writeFile(i,t,{encoding:"utf8",mode:384});try{await n.rename(i,e)}catch(a){const r=a?.code;if(r==="EEXIST"||r==="EPERM")await n.unlink(e).catch(()=>{}),await n.rename(i,e);else throw await n.unlink(i).catch(()=>{}),a}await n.chmod(e,384).catch(()=>{})}function C(e){const t=A(e.codexHome),i=e.refreshIntervalMs??h(),a=e.timeoutMs??I;let r=!1,s=!1,l=null;const p=async()=>{if(r||s)return;s=!0;const c=new AbortController;l=c;let f=!1;const _=setTimeout(()=>{f=!0,c.abort()},a);try{const u=d.spawnAsync({args:["applied","devbox","ls","--format","json"],signal:c.signal}),{stdout:y,code:D}=await u.wait();if(r||f||D!==0)return;const v=w(y);if(v==null)return;await b(t,JSON.stringify(v)),e.onCacheUpdated?.()}catch(u){if(r)return;o().warning("Applied devbox cache refresh failed",{error:d.sanitizeLogValue(u)})}finally{clearTimeout(_),s=!1,l=null}};p();const g=setInterval(()=>{p()},i);return{dispose:()=>{r=!0,clearInterval(g),l?.abort()}}}exports.atomicWriteCacheFile=b;exports.parseAppliedDevboxLsOutput=w;exports.resolveAppliedDevboxCachePath=A;exports.resolveRefreshIntervalMs=h;exports.startAppliedDevboxCacheRefresher=C;
//# sourceMappingURL=applied-devbox-cache-G3KN3v5P.js.map
